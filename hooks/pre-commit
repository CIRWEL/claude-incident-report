#!/usr/bin/env bash
# pre-commit — Detect history-rewriting tools and operations
# Part of claude-incident-report — preventing AI agents from destroying your repos.
#
# What happened: A Claude AI agent installed git-filter-repo, rewrote every commit
# in two repos to strip Co-Authored-By lines, then force-pushed. This hook detects
# signs that history rewriting is in progress or that dangerous tools are present.

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
RESET='\033[0m'

warnings=0
errors=0

GIT_DIR="$(git rev-parse --git-dir 2>/dev/null)"

# --- Check 1: git-filter-repo artifacts ---
# When git-filter-repo runs, it creates .git/filter-repo/ with mapping files.
# If this directory exists, history rewriting has happened or is happening.

if [[ -d "${GIT_DIR}/filter-repo" ]]; then
    echo -e "${RED}${BOLD}ERROR: git-filter-repo artifacts detected${RESET}"
    echo -e "${RED}  Found: ${GIT_DIR}/filter-repo/${RESET}"
    echo ""
    echo "  This directory is created by git-filter-repo when rewriting history."
    echo "  Its presence means commits in this repo have been rewritten."
    echo ""
    echo "  If you ran filter-repo intentionally and want to commit:"
    echo "    rm -rf ${GIT_DIR}/filter-repo"
    echo "    Then retry your commit."
    echo ""
    errors=$((errors + 1))
fi

# --- Check 2: git-filter-repo is installed ---
# Not necessarily an error, but worth flagging in context of AI agent safety.

if command -v git-filter-repo &>/dev/null; then
    echo -e "${YELLOW}${BOLD}WARNING: git-filter-repo is installed on this system${RESET}"
    echo -e "${YELLOW}  Location: $(command -v git-filter-repo)${RESET}"
    echo ""
    echo "  git-filter-repo is a powerful history-rewriting tool. In the incident"
    echo "  that prompted these hooks, an AI agent installed and ran it without"
    echo "  permission. Consider uninstalling it if you don't need it:"
    echo ""
    echo "    pip uninstall git-filter-repo"
    echo "    # or: brew uninstall git-filter-repo"
    echo ""
    warnings=$((warnings + 1))
fi

# --- Check 3: BFG Repo-Cleaner artifacts ---
# BFG is another history rewriter. Check for its presence too.

if command -v bfg &>/dev/null; then
    echo -e "${YELLOW}${BOLD}WARNING: BFG Repo-Cleaner is installed on this system${RESET}"
    echo -e "${YELLOW}  Location: $(command -v bfg)${RESET}"
    echo ""
    echo "  BFG is a history-rewriting tool similar to git-filter-repo."
    echo ""
    warnings=$((warnings + 1))
fi

# --- Check 4: Detect if we're inside a filter-branch operation ---
# git filter-branch sets GIT_DIR to a temp location and creates refs/original/.

if [[ -d "${GIT_DIR}/refs/original" ]]; then
    echo -e "${RED}${BOLD}ERROR: refs/original/ detected — history has been rewritten${RESET}"
    echo ""
    echo "  The refs/original/ directory is created by 'git filter-branch' to"
    echo "  preserve original refs before rewriting. This means the current"
    echo "  history is NOT the original history."
    echo ""
    echo "  To restore original refs:"
    echo "    git for-each-ref --format='%(refname)' refs/original/ | \\"
    echo "      while read ref; do"
    echo "        git update-ref \"\${ref#refs/original/}\" \"\$(git rev-parse \"\$ref\")\""
    echo "      done"
    echo ""
    errors=$((errors + 1))
fi

# --- Check 5: Suspicious environment variables ---
# Some rewriting tools set these. An AI agent might set them to manipulate commits.

if [[ -n "${GIT_AUTHOR_NAME:-}" || -n "${GIT_AUTHOR_EMAIL:-}" || \
      -n "${GIT_COMMITTER_NAME:-}" || -n "${GIT_COMMITTER_EMAIL:-}" ]]; then
    echo -e "${YELLOW}${BOLD}WARNING: Git identity override environment variables are set${RESET}"
    [[ -n "${GIT_AUTHOR_NAME:-}" ]] && echo -e "${YELLOW}  GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME}${RESET}"
    [[ -n "${GIT_AUTHOR_EMAIL:-}" ]] && echo -e "${YELLOW}  GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL}${RESET}"
    [[ -n "${GIT_COMMITTER_NAME:-}" ]] && echo -e "${YELLOW}  GIT_COMMITTER_NAME=${GIT_COMMITTER_NAME}${RESET}"
    [[ -n "${GIT_COMMITTER_EMAIL:-}" ]] && echo -e "${YELLOW}  GIT_COMMITTER_EMAIL=${GIT_COMMITTER_EMAIL}${RESET}"
    echo ""
    echo "  These variables override the author/committer on commits."
    echo "  History-rewriting tools use them to forge commit metadata."
    echo "  If you didn't set these intentionally, something may be wrong."
    echo ""
    warnings=$((warnings + 1))
fi

# --- Check 6: Detect replace refs ---
# git replace can silently substitute commits. An agent could use this
# to make rewritten history appear legitimate.

replace_count=$(git replace -l 2>/dev/null | wc -l | tr -d ' ')
if [[ "$replace_count" -gt 0 ]]; then
    echo -e "${YELLOW}${BOLD}WARNING: ${replace_count} git replace ref(s) found${RESET}"
    echo ""
    echo "  Replace refs silently substitute one object for another."
    echo "  Run 'git replace -l' to see them."
    echo ""
    warnings=$((warnings + 1))
fi

# --- Summary ---

if [[ "$errors" -gt 0 ]]; then
    echo -e "${RED}${BOLD}Commit blocked: ${errors} error(s), ${warnings} warning(s)${RESET}"
    echo -e "${RED}Fix the errors above before committing.${RESET}"
    echo ""
    exit 1
fi

if [[ "$warnings" -gt 0 ]]; then
    echo -e "${YELLOW}${BOLD}Commit proceeding with ${warnings} warning(s).${RESET}"
    echo ""
fi

exit 0
