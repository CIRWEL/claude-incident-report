#!/usr/bin/env bash
# pre-push — Block force-push attempts
# Part of obtuse-hubris — preventing AI agents from destroying your repos.
#
# What happened: A Claude AI agent force-pushed rewritten history to two production
# repos, destroying all original commits. This hook exists so that can never happen
# silently again.
#
# Override: I_KNOW_WHAT_FORCE_PUSH_DOES=1 git push --force
# This is intentionally cumbersome. You should have to think about it.

set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
RESET='\033[0m'

# --- Detect force-push from command line arguments ---

# Git invokes pre-push with: <remote-name> <remote-url>
# and feeds lines on stdin: <local-ref> <local-sha> <remote-ref> <remote-sha>
REMOTE_NAME="${1:-}"
REMOTE_URL="${2:-}"

force_detected=0
force_reason=""

# Method 1: Check the parent process command line for --force flags.
# This catches: git push --force, git push -f, git push --force-with-lease
parent_cmdline=""
if [[ "$(uname)" == "Darwin" ]]; then
    parent_cmdline=$(ps -o args= -p "$PPID" 2>/dev/null || true)
else
    parent_cmdline=$(cat "/proc/$PPID/cmdline" 2>/dev/null | tr '\0' ' ' || true)
fi

if echo "$parent_cmdline" | grep -qE '(^|\s)(--force-with-lease|--force|-f)(\s|$)'; then
    force_detected=1
    force_reason="Force-push flag detected in command: $parent_cmdline"
fi

# Method 2: Check stdin for refspecs that indicate a force-push.
# A '+' prefix on local ref means force update. A delete (empty local sha) is also
# flagged since deleting remote refs remotely can be equally destructive.
ZERO="0000000000000000000000000000000000000000"

while read -r local_ref local_sha remote_ref remote_sha; do
    # Forced refspec: +refs/heads/main:refs/heads/main
    if [[ "$local_ref" == +* ]]; then
        force_detected=1
        force_reason="Forced refspec detected: $local_ref -> $remote_ref"
    fi

    # Deleting a remote branch (local sha is all zeros)
    if [[ "$local_sha" == "$ZERO" ]]; then
        force_detected=1
        force_reason="Remote branch deletion detected: $remote_ref"
    fi

    # Non-fast-forward push: local sha exists, remote sha exists, but local is not
    # a descendant of remote. This is the actual definition of a force-push.
    if [[ "$local_sha" != "$ZERO" && "$remote_sha" != "$ZERO" ]]; then
        if ! git merge-base --is-ancestor "$remote_sha" "$local_sha" 2>/dev/null; then
            force_detected=1
            force_reason="Non-fast-forward push detected: $local_ref ($local_sha) does not contain $remote_ref ($remote_sha)"
        fi
    fi
done

# --- If force-push detected, block or warn ---

if [[ "$force_detected" -eq 1 ]]; then
    if [[ "${I_KNOW_WHAT_FORCE_PUSH_DOES:-0}" == "1" ]]; then
        echo -e "${YELLOW}${BOLD}WARNING: Force-push override active.${RESET}"
        echo -e "${YELLOW}You set I_KNOW_WHAT_FORCE_PUSH_DOES=1. Proceeding.${RESET}"
        echo -e "${YELLOW}Reason: ${force_reason}${RESET}"
        echo ""
        exit 0
    fi

    echo ""
    echo -e "${RED}${BOLD}======================================================${RESET}"
    echo -e "${RED}${BOLD}  FORCE-PUSH BLOCKED${RESET}"
    echo -e "${RED}${BOLD}======================================================${RESET}"
    echo ""
    echo -e "${RED}Reason: ${force_reason}${RESET}"
    echo ""
    echo -e "${BOLD}What force-push does:${RESET}"
    echo "  - Replaces the remote branch history with your local history"
    echo "  - Any commits on remote that are not in your local branch are LOST"
    echo "  - Other developers' work based on the old history becomes orphaned"
    echo "  - There is no undo. The remote reflog is not accessible to most users."
    echo ""
    echo -e "${BOLD}Why this hook exists:${RESET}"
    echo "  On Feb 25, 2026, a Claude AI agent force-pushed rewritten history to"
    echo "  two production repositories. It had used git-filter-repo to rewrite"
    echo "  every commit, then disabled branch protection via the GitHub API,"
    echo "  force-pushed, and re-enabled protection. ~80 commits were lost on"
    echo "  the remote. During recovery it ran 'git reset --hard', destroying"
    echo "  the last local recovery window."
    echo ""
    echo -e "${BOLD}To override (if you genuinely need to force-push):${RESET}"
    echo ""
    echo "  I_KNOW_WHAT_FORCE_PUSH_DOES=1 git push --force"
    echo ""
    echo "  This variable is checked per-invocation. It is intentionally not"
    echo "  something you set in your shell profile."
    echo ""
    echo -e "${RED}${BOLD}======================================================${RESET}"
    echo ""
    exit 1
fi

exit 0
